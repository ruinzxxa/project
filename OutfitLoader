local httpService = game:GetService("HttpService")

local baseUrl1 = "https://avatar.roblox.com/v1/users/"
local baseUrl2 = "/outfits?itemsPerPage=50"
local requests = {}

local outfitsFolder = workspace.loadedOutfits

local proxyHttp = require(game.ServerScriptService.ProxyRobloxAPI:Clone())
wait()

local checkPlayer = function()
	if #requests >= 1 then
		local userId = (requests[1])
		table.remove(requests, table.find(requests, userId))
		local s, x = pcall(function()
			local data = proxyHttp:GetAsync(baseUrl1..userId..baseUrl2)
			if data then
				outfitsFolder:ClearAllChildren()
				local outfits = data.data
				game:GetService("Lighting").Values.waitvalue.Value = #outfits -25
				for i, v in pairs(outfits) do
					local desc = game.Players:GetHumanoidDescriptionFromOutfitId(v.id)
					local response = proxyHttp:GetAsync("https://avatar.roblox.com/v1/outfits/"..v.id.."/details")
					if response.playerAvatarType == "R6" then
						local c = game.ServerStorage.BaseAvatarR6:Clone()
						c.Name = v.name
						c.Parent = outfitsFolder
						c.HumanoidRootPart.CFrame = CFrame.new(-30 + (5 * (#outfitsFolder:GetChildren() - 1)), 4, -49.578)	
						c.Humanoid.NameDisplayDistance = 50
						c.Humanoid:ApplyDescription(desc)
						c.HumanoidRootPart.Orientation = Vector3.new(0,180,0)
					else
						local c = game.ServerStorage.BaseAvatarR15:Clone()
						c.Name = v.name
						c.Parent = outfitsFolder
						c.HumanoidRootPart.Position = Vector3.new(-30 + (5 * (#outfitsFolder:GetChildren() - 1)), 4, -49.578)
						c.Humanoid.NameDisplayDistance = 50
						c.Humanoid:ApplyDescription(desc)
					end
				end
			end
		end)
		if not s and x then warn(x) end
	end
end

local loop = function()
	while true do
		wait(7.5)
		if #requests >= 1 then
			checkPlayer()
		else
			repeat game:GetService("RunService").Heartbeat:Wait() until #requests >= 1
		end
	end
end

game.ReplicatedStorage.RequestUser.OnServerInvoke = function(plr, targetName)
	local s, x = pcall(function()
		local targetUserId = game.Players:GetUserIdFromNameAsync(targetName)
		if targetUserId ~= nil then
			local isOnRequests = false
			for i, v in pairs(requests) do
				if v == targetUserId then
					isOnRequests = true
					break
				end
			end
			if isOnRequests == false then
				table.insert(requests, targetUserId)
				if #requests == 1 then
					checkPlayer()
				end
				return "Put in queue!"
			else
				return "User is already on list!"
			end
		else
			return "User doesn't exist!"
		end
	end)
	if not s and x then warn(x) end
end

coroutine.wrap(loop)()
